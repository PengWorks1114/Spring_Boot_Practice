
### 1. 建立記事流程 (POST /notes)
---
當使用者在網頁上填寫 **標題**、**內容** 和 **密碼**，並點擊「儲存」按鈕時，會觸發以下流程：

1.  **前端發送請求**：瀏覽器中的 JavaScript 會將使用者輸入的資料打包成一個 JSON 物件，然後透過 `fetch` API，以 **POST** 請求發送到後端 API 的 `/notes` 端點。
2.  **Controller 接收請求**：後端的 `NoteController` 會接收到這個請求。`@RequestBody` 註解會將 JSON 資料自動轉換成 `CreateNoteRequest` 物件。同時，`@Valid` 註解會啟用驗證功能，檢查標題和密碼的格式是否符合要求。
3.  **Service 處理商業邏輯**：`NoteController` 會呼叫 `NoteService` 的 `create` 方法。
    * `NoteService` 會將明文內容和密碼傳遞給 `CryptoService`。
    * `CryptoService` 使用 **PBKDF2** 演算法，根據密碼和隨機生成的 **鹽（salt）** 衍生出一個加密金鑰。
    * 接著，它會使用 **AES-GCM** 演算法，將純文字內容進行加密，產生 **密文** 和 **IV**，並將密文、鹽和 IV 都用 **Base64** 編碼。
    * `NoteService` 會將使用者的密碼，透過 `BCryptPasswordEncoder` 進行雜湊，產生一個 **雜湊密碼**。這是一個額外的安全機制，用來在解密前快速檢查密碼是否正確，以節省資源。
4.  **資料庫儲存**：`NoteService` 將加密後的資料（密文、鹽、IV 等），以及雜湊密碼，組裝成一個 `Note` 實體物件，並呼叫 `NoteRepository` 的 `save` 方法。
    * **重點：** 你的伺服器上**從未儲存過明文內容或使用者輸入的原始密碼**。這確保了即使資料庫被洩露，記事內容也無法被讀取。
5.  **回傳回應**：`NoteRepository` 將資料存入 H2 資料庫後，`NoteService` 會回傳一個包含新記事 ID 和標題的 `NoteCreatedResponse` 物件給 `NoteController`。
6.  **前端顯示結果**：`NoteController` 將這個物件轉換成 JSON，並以 HTTP **201 Created** 狀態碼回傳給前端。前端收到回應後，將 ID 顯示給使用者。

### 2. 解密讀取流程 (GET /notes/{id}?pass=...)
---
當使用者輸入記事 ID 和密碼，並點擊「解密」按鈕時，以下流程會啟動：

1.  **前端發送請求**：瀏覽器以 **GET** 請求發送到 `/notes/{id}?pass=...` 端點，將記事 ID 放在路徑中，將密碼放在查詢參數中。
2.  **Controller 接收請求**：`NoteController` 的 `read` 方法接收到這個請求。`@PathVariable` 會從路徑中取出 ID，`@RequestParam` 會從查詢參數中取出密碼。
3.  **Service 處理商業邏輯**：`NoteController` 呼叫 `NoteService` 的 `decrypt` 方法。
    * `NoteService` 首先會用 `NoteRepository` 根據 ID 查詢資料庫。如果找不到，它會拋出例外。
    * `NoteService` 接著會進行一個重要的安全檢查：它會先用 `BCryptPasswordEncoder` 比較使用者提供的密碼和資料庫中儲存的雜湊密碼。如果兩者不匹配，它會立即拋出 `InvalidPassException`。這個快速檢查避免了不必要的、耗費大量計算資源的加解密嘗試。
    * 如果密碼初步檢查通過，`NoteService` 會將儲存在資料庫中的密文、鹽、IV 等參數，與使用者提供的密碼一起傳給 `CryptoService`。
    * `CryptoService` 會用這些參數來重新衍生加密金鑰，然後嘗試對密文進行解密。
4.  **解密驗證與回傳**：
    * 如果解密成功，`CryptoService` 會回傳明文內容。
    * 如果密碼不正確（即使通過了雜湊檢查），AES-GCM 的 **認證標籤** 也會因為不匹配而導致解密失敗，`CryptoService` 會拋出例外。`NoteService` 捕獲此例外，並將其視為密碼錯誤，再次拋出 `InvalidPassException`。
5.  **統一錯誤處理**：如果 `NoteService` 拋出任何例外（如 `NoSuchElementException` 或 `InvalidPassException`），`NoteController` 的 `@ExceptionHandler` 會捕獲它們，並自動生成一個標準化的 JSON 錯誤回應，例如 404 Not Found 或 403 Forbidden。
6.  **回傳成功回應**：如果所有步驟都成功，`NoteService` 會回傳一個包含明文內容的 `DecryptNoteResponse` 物件給 `NoteController`。
7.  **前端顯示結果**：`NoteController` 將這個物件轉換成 JSON，並以 HTTP **200 OK** 狀態碼回傳給前端。前端收到後，將明文內容顯示在網頁上。

