// å‚³æ¡ˆåç¨±æœ‰æ›´æ”¹

# Day 2ï½œå›è²èˆ‡æ™‚é–“ä¼ºæœå™¨ï¼šåŸºæœ¬è¨­è¨ˆæ›¸ï¼ˆå«å‰ç«¯ä»‹é¢ï¼‰


## 1. ç›®çš„èˆ‡ç¯„åœ

* **ç›®çš„**ï¼šé€éå…©å€‹æ¥µå°è€Œå®Œæ•´çš„ç«¯é»ï¼Œç·´ç¿’ Request/Responseã€åƒæ•¸é©—è­‰ã€éŒ¯èª¤è™•ç†èˆ‡å‰å¾Œç«¯ä¸²æ¥ã€‚
* **ç¯„åœ**ï¼š

    * å¾Œç«¯ï¼šSpring Boot REST APIï¼ˆ`/echo`, `/now`ï¼‰ï¼ŒåŠ å…¥ Bean Validation èˆ‡å…¨åŸŸä¾‹å¤–è™•ç†ã€‚
    * å‰ç«¯ï¼šå–®ä¸€ HTMLï¼ˆBootstrapï¼‰+ åŸç”Ÿ JS ç¯„ä¾‹é ï¼Œæä¾›æ¸¬è©¦è¡¨å–®èˆ‡çµæœé¡¯ç¤ºã€‚
    * æ–‡ä»¶ï¼šOpenAPI è¦æ ¼ã€é©—æ”¶æ¢ä»¶èˆ‡æ¸¬è©¦æ¡ˆä¾‹ã€‚

---

## 2. ç³»çµ±æ§‹æˆèˆ‡æŠ€è¡“

* **å¾Œç«¯**ï¼šJava 17ã€Spring Boot 3.xã€spring-boot-starter-webã€spring-boot-starter-validationã€springdoc-openapiã€‚
* **å‰ç«¯**ï¼šHTML + Bootstrap 5 + åŸç”Ÿ fetchã€‚
* **æ™‚å€**ï¼šä»¥ `java.time.ZoneId` é©—è­‰ï¼›è‹¥æœªæä¾› `tz`ï¼Œé è¨­ `Asia/Tokyo`ã€‚
* **éŒ¯èª¤æ ¼å¼**ï¼šRFC 7807 é¢¨æ ¼ï¼ˆProblem Detailsï¼‰æˆ–ç­‰åƒ¹è‡ªè¨‚ JSONã€‚

---

## 3. ç«¯é»è¦æ ¼ï¼ˆAPI Specï¼‰

### 3.1 POST `/echo`

* **èªªæ˜**ï¼šå›å‚³åŸæ–‡å…§å®¹èˆ‡å­—æ•¸ã€‚
* **Request Bodyï¼ˆJSONï¼‰**ï¼š

  ```json
  {
    "text": "Hello world"
  }
  ```
* **é©—è­‰è¦å‰‡**ï¼š

    * `text` ä¸å¯ç‚º `null`ã€‚
    * `text` å»é™¤å‰å¾Œç©ºç™½å¾Œä¸å¾—ç‚ºç©ºå­—ä¸²ã€‚
    * é•·åº¦ä¸Šé™é è¨­ 2,000 å­—å…ƒï¼ˆå¯æ–¼è¨­å®šæª”èª¿æ•´ï¼‰ã€‚
* **200 OKï¼ˆJSONï¼‰**ï¼š

  ```json
  {
    "original": "Hello world",
    "length": 11
  }
  ```

    * `length` è¨ˆç®—ä»¥ Unicode code point ç‚ºæº–ï¼ˆé¿å… emoji/ä»£ç†å°èª¤å·®ï¼‰ã€‚
* **400 Bad Requestï¼ˆJSON, Problem Detailsï¼‰**ï¼š

  ```json
  {
    "type": "about:blank",
    "title": "Bad Request",
    "status": 400,
    "detail": "text must not be blank",
    "errors": [
      {"field":"text","message":"must not be blank"}
    ],
    "timestamp": "2025-08-22T04:20:00Z",
    "traceId": "a1b2c3..."
  }
  ```

### 3.2 GET `/now`

* **èªªæ˜**ï¼šå›å‚³æŒ‡å®šæ™‚å€çš„ç•¶å‰æ™‚é–“ã€‚
* **Query Parameters**ï¼š

    * `tz`ï¼ˆé¸å¡«ï¼‰ï¼šIANA æ™‚å€å­—ä¸²ï¼ˆä¾‹å¦‚ `Asia/Tokyo`, `UTC`, `Europe/Paris`ï¼‰ã€‚
* **è¡Œç‚º**ï¼š

    * æœªæä¾› `tz` â†’ é è¨­ `Asia/Tokyo`ã€‚
    * æä¾›ç„¡æ•ˆ `tz` â†’ 400ã€‚
* **200 OKï¼ˆJSONï¼‰**ï¼š

  ```json
  {
    "zone": "Asia/Tokyo",
    "instant": "2025-08-22T04:20:00Z",
    "localDateTime": "2025-08-22T13:20:00",
    "offset": "+09:00",
    "epochMilli": 1766444400000
  }
  ```
* **400 Bad Requestï¼ˆJSONï¼‰**ï¼ˆç„¡æ•ˆ `tz`ï¼‰ï¼š

  ```json
  {
    "type": "about:blank",
    "title": "Bad Request",
    "status": 400,
    "detail": "Invalid time zone: Asia/Tyoko",
    "errors": [],
    "timestamp": "2025-08-22T04:20:01Z",
    "traceId": "d4e5f6..."
  }
  ```

---

## 4. çµæ§‹è¨­è¨ˆï¼ˆå¾Œç«¯ï¼‰

### 4.1 å°ˆæ¡ˆåŒ…çµæ§‹

```
com.example.day2
 â”œâ”€ controller
 â”‚   â”œâ”€ EchoController.java
 â”‚   â””â”€ TimeController.java
 â”œâ”€ dto
 â”‚   â”œâ”€ EchoRequest.java
 â”‚   â””â”€ EchoResponse.java
 â”‚   â””â”€ NowResponse.java
 â”œâ”€ exception
 â”‚   â”œâ”€ GlobalExceptionHandler.java   // @ControllerAdvice
 â”‚   â””â”€ ApiError.java                 // Problem Details
 â”œâ”€ service
 â”‚   â”œâ”€ EchoService.java
 â”‚   â””â”€ TimeService.java
 â”œâ”€ util
 â”‚   â””â”€ TextLength.java               // Unicode é•·åº¦å·¥å…·
 â””â”€ Day2Application.java
```

### 4.2 DTO å®šç¾©ï¼ˆé‡é»æ¬„ä½ï¼‰

* `EchoRequest`

    * `String text`ï¼ˆ`@NotNull`ã€è‡ªè¨‚ `@NotBlankTrimmed`ã€`@Size(max=2000)`ï¼‰
* `EchoResponse`

    * `String original`ã€`int length`
* `NowResponse`

    * `String zone`ã€`String instant`ï¼ˆISO-8601 UTCï¼‰ã€`String localDateTime`ã€`String offset`ã€`long epochMilli`

### 4.3 é©—è­‰èˆ‡éŒ¯èª¤è™•ç†

* ä½¿ç”¨ `jakarta.validation` é©—è­‰ Body/Queryã€‚
* å…¨åŸŸä¾‹å¤–è™•ç†ï¼š

    * `MethodArgumentNotValidException` â†’ å½™æ•´æ¬„ä½éŒ¯èª¤è‡³ `errors[]`ã€‚
    * `ConstraintViolationException`ï¼ˆQuery åƒæ•¸ï¼‰â†’ è½‰ Problem JSONã€‚
    * `DateTimeException`ï¼ˆç„¡æ•ˆæ™‚å€ï¼‰â†’ è½‰ 400ã€‚
    * å…¶ä»–æœªæ•æ‰ â†’ 500ï¼Œéš±è—ç´°ç¯€ï¼Œä¿ç•™ `traceId`ã€‚

---

## 5. å‰ç«¯ä»‹é¢ï¼ˆå–®æª” HTMLï¼‰

### 5.1 éœ€æ±‚

* ä¸€é å«å…©å¡ç‰‡ï¼š

    1. Echo æ¸¬è©¦ï¼šæ–‡å­—è¼¸å…¥ã€é€å‡ºã€é¡¯ç¤º original/lengthã€‚
    2. Now æ¸¬è©¦ï¼štz è¼¸å…¥ï¼ˆå«ä¸‹æ‹‰å¸¸ç”¨é¸å–®ï¼‰ã€é¡¯ç¤º zone/instant/localDateTime/offsetã€‚
* é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯èˆ‡ 400 å…§å®¹ã€‚
* ä½¿ç”¨ Bootstrap 5ã€åŸç”Ÿ `fetch`ã€‚

### 5.2 ç¯„ä¾‹é ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰

```html
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Day 2ï½œEcho & Time Client</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4">Day 2ï½œEcho & Time Client</h1>

  <!-- Echo -->
  <div class="card mb-4">
    <div class="card-header fw-bold">/echo æ¸¬è©¦</div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">è¼¸å…¥æ–‡å­—</label>
        <textarea id="echoText" class="form-control" rows="3" placeholder="è¼¸å…¥ä»»æ„æ–‡å­—"></textarea>
      </div>
      <button id="btnEcho" class="btn btn-primary">é€å‡º</button>
      <pre id="echoResult" class="mt-3 bg-body-tertiary p-3 border rounded" style="white-space:pre-wrap"></pre>
    </div>
  </div>

  <!-- Now -->
  <div class="card">
    <div class="card-header fw-bold">/now æ¸¬è©¦</div>
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-sm-6">
          <label class="form-label">IANA æ™‚å€ï¼ˆé¸å¡«ï¼‰</label>
          <input id="tz" class="form-control" placeholder="Asia/Tokyo" list="tzList">
          <datalist id="tzList">
            <option value="Asia/Tokyo"></option>
            <option value="UTC"></option>
            <option value="Europe/Paris"></option>
            <option value="America/Los_Angeles"></option>
            <option value="Asia/Taipei"></option>
          </datalist>
        </div>
        <div class="col-auto">
          <button id="btnNow" class="btn btn-success">å–å¾—æ™‚é–“</button>
        </div>
      </div>
      <pre id="nowResult" class="mt-3 bg-body-tertiary p-3 border rounded"></pre>
    </div>
  </div>
</div>

<script>
const apiBase = ""; // åŒåŸŸéƒ¨ç½²æ™‚ç•™ç©ºï¼›è·¨åŸŸæ™‚å¡«å…¥ http://localhost:8080 ç­‰

async function postEcho() {
  const text = document.getElementById('echoText').value;
  const resBox = document.getElementById('echoResult');
  resBox.textContent = "åŸ·è¡Œä¸­â€¦";
  try {
    const resp = await fetch(`${apiBase}/echo`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ text })
    });
    const json = await resp.json();
    resBox.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    resBox.textContent = `ç™¼ç”ŸéŒ¯èª¤ï¼š${e}`;
  }
}

async function getNow() {
  const tz = document.getElementById('tz').value.trim();
  const resBox = document.getElementById('nowResult');
  resBox.textContent = "åŸ·è¡Œä¸­â€¦";
  const url = tz ? `${apiBase}/now?tz=${encodeURIComponent(tz)}` : `${apiBase}/now`;
  try {
    const resp = await fetch(url);
    const json = await resp.json();
    resBox.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    resBox.textContent = `ç™¼ç”ŸéŒ¯èª¤ï¼š${e}`;
  }
}

document.getElementById('btnEcho').addEventListener('click', postEcho);
document.getElementById('btnNow').addEventListener('click', getNow);
</script>
</body>
</html>
```

---

## 6. å¾Œç«¯ç¯„ä¾‹ï¼ˆæ ¸å¿ƒç¨‹å¼éª¨æ¶ï¼‰

### 6.1 EchoController / Serviceï¼ˆç¯€éŒ„ï¼‰

```java
@RestController
@RequiredArgsConstructor
public class EchoController {
  private final EchoService echoService;

  @PostMapping("/echo")
  public ResponseEntity<EchoResponse> echo(@Valid @RequestBody EchoRequest req) {
    return ResponseEntity.ok(echoService.echo(req));
  }
}

@Service
public class EchoService {
  public EchoResponse echo(EchoRequest req) {
    final String original = req.getText();
    final int length = original.codePointCount(0, original.length());
    return new EchoResponse(original, length);
  }
}
```

```java
@Getter @Setter
public class EchoRequest {
  @NotNull(message = "text must not be null")
  @Size(max = 2000, message = "text too long")
  private String text;

  @AssertTrue(message = "text must not be blank")
  public boolean isNotBlankAfterTrim() {
    return text != null && !text.trim().isEmpty();
  }
}
```

### 6.2 TimeController / Serviceï¼ˆç¯€éŒ„ï¼‰

```java
@RestController
@RequiredArgsConstructor
public class TimeController {
  private final TimeService timeService;

  @GetMapping("/now")
  public ResponseEntity<NowResponse> now(@RequestParam(required = false) String tz) {
    return ResponseEntity.ok(timeService.now(tz));
  }
}

@Service
public class TimeService {
  public NowResponse now(String tz) {
    final String zoneId = (tz == null || tz.isBlank()) ? "Asia/Tokyo" : tz.trim();
    try {
      ZoneId zone = ZoneId.of(zoneId);
      Instant instant = Instant.now();
      ZonedDateTime zdt = instant.atZone(zone);
      return new NowResponse(
        zone.getId(),
        instant.toString(),
        zdt.toLocalDateTime().toString(),
        zdt.getOffset().toString(),
        instant.toEpochMilli()
      );
    } catch (DateTimeException ex) {
      throw new IllegalArgumentException("Invalid time zone: " + zoneId);
    }
  }
}
```

### 6.3 å…¨åŸŸä¾‹å¤–è™•ç†ï¼ˆç¯€éŒ„ï¼‰

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

  @ExceptionHandler(MethodArgumentNotValidException.class)
  @ResponseStatus(HttpStatus.BAD_REQUEST)
  public ApiError handleValidation(MethodArgumentNotValidException ex) {
    List<ApiError.FieldError> fieldErrors = ex.getBindingResult().getFieldErrors().stream()
      .map(fe -> new ApiError.FieldError(fe.getField(), fe.getDefaultMessage()))
      .toList();
    return ApiError.badRequest("Validation failed", fieldErrors);
  }

  @ExceptionHandler(ConstraintViolationException.class)
  @ResponseStatus(HttpStatus.BAD_REQUEST)
  public ApiError handleConstraint(ConstraintViolationException ex) {
    List<ApiError.FieldError> errors = ex.getConstraintViolations().stream()
      .map(v -> new ApiError.FieldError(v.getPropertyPath().toString(), v.getMessage()))
      .toList();
    return ApiError.badRequest("Constraint violation", errors);
  }

  @ExceptionHandler(IllegalArgumentException.class)
  @ResponseStatus(HttpStatus.BAD_REQUEST)
  public ApiError handleIllegalArgument(IllegalArgumentException ex) {
    return ApiError.badRequest(ex.getMessage(), List.of());
  }

  @ExceptionHandler(Exception.class)
  @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
  public ApiError handleOthers(Exception ex) {
    return ApiError.internalServerError("Unexpected error");
  }
}
```

---

## 7. è¨­å®šèˆ‡æ–‡ä»¶

### 7.1 `application.yml`ï¼ˆé‡é»ï¼‰

```yaml
server:
  port: 8080

app:
  echo:
    max-length: 2000

springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
```

### 7.2 OpenAPIï¼ˆç¸®ç•¥ç¤ºæ„ï¼‰

```yaml
openapi: 3.0.3
info:
  title: Day 2 Echo & Time API
  version: 1.0.0
paths:
  /echo:
    post:
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [text]
              properties:
                text:
                  type: string
                  maxLength: 2000
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  original: { type: string }
                  length: { type: integer }
        '400':
          $ref: '#/components/responses/BadRequest'
  /now:
    get:
      parameters:
        - in: query
          name: tz
          required: false
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  zone: { type: string }
                  instant: { type: string, format: date-time }
                  localDateTime: { type: string }
                  offset: { type: string }
                  epochMilli: { type: integer, format: int64 }
        '400':
          $ref: '#/components/responses/BadRequest'
components:
  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            type: object
            properties:
              type: { type: string }
              title: { type: string }
              status: { type: integer }
              detail: { type: string }
              errors:
                type: array
                items:
                  type: object
                  properties:
                    field: { type: string }
                    message: { type: string }
              timestamp: { type: string, format: date-time }
              traceId: { type: string }
```

---

## 8. é©—æ”¶æ¢ä»¶ï¼ˆAcceptance Criteriaï¼‰

1. **/echo**

    * `POST /echo` å‚³å…¥æ­£å¸¸å­—ä¸² â†’ å›å‚³ `original` èˆ‡æ­£ç¢º `length`ï¼ˆemojiã€CJK èƒ½æ­£ç¢ºè¨ˆæ•¸ï¼‰ã€‚
    * `text` ç‚º `null`ã€ç©ºç™½æˆ–åªå«ç©ºç™½ â†’ 400 ä¸¦åŒ…å«æ¬„ä½éŒ¯èª¤è¨Šæ¯ã€‚
    * è¶…é 2000 å­—å…ƒ â†’ 400ã€‚
2. **/now**

    * `GET /now` ä¸å¸¶ `tz` â†’ `zone=Asia/Tokyo` ä¸”æ™‚é–“èˆ‡ç³»çµ±ç›¸ç¬¦ï¼ˆÂ±1 ç§’ï¼‰ã€‚
    * `GET /now?tz=UTC` â†’ `offset=+00:00`ã€‚
    * ç„¡æ•ˆæ™‚å€ â†’ 400ï¼Œ`detail` èªªæ˜ç„¡æ•ˆæ™‚å€å€¼ã€‚
3. **æ–‡ä»¶èˆ‡ UI**

    * Swagger UI å¯æ­£å¸¸é–‹å•Ÿä¸¦æ¸¬è©¦ã€‚
    * å‰ç«¯é é¢èƒ½ä»¥ fetch ä¸²æ¥å…©ç«¯é»ï¼Œé¡¯ç¤ºæˆåŠŸèˆ‡éŒ¯èª¤çµæœã€‚
4. **éŒ¯èª¤è™•ç†**

    * æ‰€æœ‰ 400/500 éƒ½è¼¸å‡ºä¸€è‡´ Problem JSONï¼ŒåŒ…å« `timestamp` èˆ‡ `status`ã€‚

---

## 9. æ¸¬è©¦è¨­è¨ˆï¼ˆé‡é»æ¡ˆä¾‹ï¼‰

### 9.1 å–®å…ƒæ¸¬è©¦ï¼ˆJUnit + MockMvcï¼‰

* `/echo`

    * æ­£å¸¸å­—ä¸² `"Hello"` â†’ `length=5`
    * CJK `"ä½ å¥½"` â†’ `length=2`
    * Emoji `"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"`ï¼ˆå®¶åº­åˆå­—ï¼‰â†’ `length` ä»¥ code point è¨ˆï¼›å¯åŠ è¨»èªªæ˜èˆ‡æœŸæœ›å€¼
    * `null`ã€`"   "`ã€è¶…é•·å­—ä¸² â†’ 400
* `/now`

    * ç©º `tz`ã€`Asia/Tokyo`ã€`UTC` â†’ æª¢æŸ¥ `zone` èˆ‡ `offset`
    * ç„¡æ•ˆ `tz=Asia/Tyoko` â†’ 400

### 9.2 API æ¸¬è©¦ï¼ˆPostman/Rest Clientï¼‰

* é‡å°ä¸Šè¿°æ¡ˆä¾‹å»ºç«‹ collectionï¼Œä¸¦é©—è­‰ç‹€æ…‹ç¢¼èˆ‡é—œéµæ¬„ä½ã€‚

---

## 10. éåŠŸèƒ½æ€§éœ€æ±‚

* **æ•ˆèƒ½**ï¼šå–®æ¬¡è«‹æ±‚ < 50msï¼ˆæœ¬æ©Ÿï¼‰ã€‚
* **å®‰å…¨**ï¼šæ¥å— `application/json`ï¼›æ‹’çµ•é JSON Content-Type çš„ `/echo` è«‹æ±‚ï¼ˆ415ï¼‰ã€‚
* **å¯ç¶­è­·æ€§**ï¼šæœå‹™èˆ‡é©—è­‰é‚è¼¯åˆ†å±¤ï¼›éŒ¯èª¤è™•ç†é›†ä¸­æ–¼ `@ControllerAdvice`ã€‚
* **å¯è§€æ¸¬æ€§**ï¼šåœ¨ `ApiError` ä¸­è¼¸å‡º `traceId`ï¼ˆå¯æ•´åˆ `Slf4j MDC`ï¼‰ã€‚

---

## 11. å»¶ä¼¸èˆ‡åŠ åˆ†é …

* **æ™‚å€æ¸…å–®ç«¯é»**ï¼š`GET /zones` å›å‚³å¸¸è¦‹ IANA æ™‚å€é™£åˆ—ï¼Œå‰ç«¯ datalist è‡ªå‹•å¸¶å…¥ã€‚
* **i18n**ï¼šéŒ¯èª¤è¨Šæ¯åœ‹éš›åŒ–ï¼ˆ`messages_zh_TW.properties`ï¼‰ã€‚
* **CORS**ï¼šè‹¥å‰å¾Œç«¯åˆ†é›¢ï¼Œæ–¼ `CorsConfiguration` é–‹æ”¾æ¸¬è©¦ä¾†æºã€‚
* **Docker**ï¼šæä¾› `Dockerfile` èˆ‡ `compose.yaml`ã€‚

---

## 12. å»ºç½®èˆ‡å•Ÿå‹•ï¼ˆæ¦‚è¦ï¼‰

1. æ–°å¢ä¾è³´ï¼š

    * `spring-boot-starter-web`, `spring-boot-starter-validation`, `org.springdoc:springdoc-openapi-starter-webmvc-ui`
2. å•Ÿå‹• `Day2Application`ï¼Œç€è¦½ï¼š

    * Swagger UIï¼š`/swagger-ui/index.html`
    * å‰ç«¯æ¸¬è©¦é ï¼š`/client/day2.html`ï¼ˆå¯æ”¾ `src/main/resources/static`ï¼‰

---

## 13. äº¤ä»˜ç‰©

* å¾Œç«¯åŸå§‹ç¢¼ï¼ˆå«æ¸¬è©¦ï¼‰ã€‚
* `application.yml` èˆ‡ OpenAPI ç”¢å‡ºã€‚
* `static/day2.html` å‰ç«¯æ¸¬è©¦é ã€‚
* Postman Collectionï¼ˆé¸é…ï¼‰ã€‚
