<!DOCTYPE html>
<html lang="zh-Hant" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>短網址服務</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="h-full flex items-center justify-center">

<div class="max-w-xl w-full p-8 space-y-8 bg-white rounded-lg custom-shadow">
    <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900">短網址服務</h1>
        <p class="mt-2 text-sm text-gray-500">輸入長網址，立即獲得簡短、易於分享的短連結。</p>
    </div>

    <form id="shortenForm" class="space-y-6">
        <div>
            <label for="urlInput" class="sr-only">原始網址</label>
            <input id="urlInput" name="url" type="url" required class="appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="請輸入網址，例如：https://example.com">
            <div id="urlFeedback" class="mt-2 text-sm text-red-600 hidden"></div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="ttlPresetSelect" class="block text-sm font-medium text-gray-700">有效期限 (TTL)</label>
                <select id="ttlPresetSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    <option value="86400">1 天</option>
                    <option value="2592000" selected>30 天</option>
                    <option value="7776000">90 天</option>
                    <option value="">永不過期</option>
                </select>
            </div>
            <div>
                <label for="ttlCustomInput" class="block text-sm font-medium text-gray-700">或自訂 (秒)</label>
                <input id="ttlCustomInput" type="number" min="1" max="7776000" class="mt-1 relative block w-full px-4 py-2 border border-gray-300 placeholder-gray-400 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="秒數">
                <div id="ttlFeedback" class="mt-2 text-sm text-red-600 hidden"></div>
            </div>
        </div>

        <div>
            <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                產生短連結
            </button>
        </div>
    </form>

    <div id="resultBox" class="mt-8 p-4 bg-gray-50 border border-gray-200 rounded-md hidden">
        <p class="text-sm text-gray-500">您的短連結：</p>
        <div class="flex items-center mt-1">
            <span id="shortUrlDisplay" class="font-mono text-lg text-blue-600 break-all flex-1"></span>
            <button id="copyBtn" class="ml-4 p-2 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                </svg>
            </button>
            <a id="openBtn" href="#" target="_blank" class="p-2 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                    <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                </svg>
            </a>
        </div>
    </div>

    <div class="mt-6">
        <h2 class="text-lg font-medium text-gray-900">近期建立</h2>
        <ul id="recentList" class="mt-4 space-y-3"></ul>
    </div>

    <div class="text-center mt-8 text-sm text-gray-400">
        v0.1 | <a href="/swagger-ui.html" target="_blank" class="underline hover:text-gray-500">API Docs</a>
    </div>

</div>

<script>
    const shortenForm = document.getElementById('shortenForm');
    const urlInput = document.getElementById('urlInput');
    const ttlPresetSelect = document.getElementById('ttlPresetSelect');
    const ttlCustomInput = document.getElementById('ttlCustomInput');
    const resultBox = document.getElementById('resultBox');
    const shortUrlDisplay = document.getElementById('shortUrlDisplay');
    const copyBtn = document.getElementById('copyBtn');
    const openBtn = document.getElementById('openBtn');
    const recentList = document.getElementById('recentList');
    const urlFeedback = document.getElementById('urlFeedback');
    const ttlFeedback = document.getElementById('ttlFeedback');

    const MAX_TTL_SECONDS = 7776000;

    document.addEventListener('DOMContentLoaded', () => {
        loadRecentLinks();
    });

    shortenForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // 隱藏所有錯誤訊息
        urlInput.classList.remove('border-red-500');
        urlFeedback.classList.add('hidden');
        ttlCustomInput.classList.remove('border-red-500');
        ttlFeedback.classList.add('hidden');

        const url = urlInput.value.trim();
        let ttlSeconds = null;

        if (ttlCustomInput.value) {
            ttlSeconds = parseInt(ttlCustomInput.value, 10);
            if (isNaN(ttlSeconds) || ttlSeconds < 1 || ttlSeconds > MAX_TTL_SECONDS) {
                ttlCustomInput.classList.add('border-red-500');
                ttlFeedback.textContent = `TTL 必須介於 1 到 ${MAX_TTL_SECONDS} 秒之間。`;
                ttlFeedback.classList.remove('hidden');
                return;
            }
        } else if (ttlPresetSelect.value) {
            ttlSeconds = parseInt(ttlPresetSelect.value, 10);
        }

        const urlPattern = /^(http|https):\/\/[^ "]+$/;
        if (!urlPattern.test(url)) {
            urlInput.classList.add('border-red-500');
            urlFeedback.textContent = '網址必須以 http 或 https 開頭，且格式正確。';
            urlFeedback.classList.remove('hidden');
            return;
        }

        try {
            const response = await fetch('/shorten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, ttlSeconds })
            });

            const data = await response.json();

            if (!response.ok) {
                showError(data);
                return;
            }

            showResult(data);
            saveToLocalStorage(data);
        } catch (error) {
            console.error('API Error:', error);
            showError({ message: '連線到伺服器時發生錯誤。' });
        }
    });

    function showError(error) {
        const message = error.message || '發生未知錯誤';
        alert(`錯誤：${message}`);
    }

    function showResult(data) {
        shortUrlDisplay.textContent = data.shortUrl;
        openBtn.href = data.shortUrl;
        resultBox.classList.remove('hidden');

        copyBtn.onclick = () => {
            navigator.clipboard.writeText(data.shortUrl).then(() => {
                alert('短連結已複製到剪貼簿！');
            }).catch(err => {
                console.error('無法複製文字:', err);
            });
        };
    }

    function saveToLocalStorage(data) {
        const recentLinks = JSON.parse(localStorage.getItem('recentLinks')) || [];
        const newLink = {
            code: data.code,
            url: urlInput.value.trim(),
            shortUrl: data.shortUrl
        };
        const existingIndex = recentLinks.findIndex(link => link.code === newLink.code);
        if (existingIndex !== -1) {
            recentLinks.splice(existingIndex, 1);
        }
        recentLinks.unshift(newLink);
        localStorage.setItem('recentLinks', JSON.stringify(recentLinks.slice(0, 5)));
        loadRecentLinks();
    }

    function loadRecentLinks() {
        const recentLinks = JSON.parse(localStorage.getItem('recentLinks')) || [];
        recentList.innerHTML = '';
        if (recentLinks.length === 0) {
            recentList.innerHTML = '<li class="text-sm text-gray-500">尚無近期記錄。</li>';
            return;
        }
        recentLinks.forEach(link => {
            const listItem = document.createElement('li');
            listItem.className = 'flex items-center justify-between p-3 bg-white rounded-md custom-shadow';

            const linkText = document.createElement('div');
            linkText.className = 'flex flex-col flex-1 min-w-0';
            linkText.innerHTML = `
                <span class="font-medium text-blue-600 truncate" title="${link.shortUrl}">${link.code}</span>
                <span class="text-xs text-gray-500 truncate" title="${link.url}">${link.url}</span>
            `;

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex space-x-2 ml-4';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'p-2 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md';
            copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>`;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(link.shortUrl).then(() => alert('已複製！'));
            };

            const openBtn = document.createElement('a');
            openBtn.className = 'p-2 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md';
            openBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>`;
            openBtn.href = link.shortUrl;
            openBtn.target = '_blank';

            buttonGroup.appendChild(copyBtn);
            buttonGroup.appendChild(openBtn);
            listItem.appendChild(linkText);
            listItem.appendChild(buttonGroup);
            recentList.appendChild(listItem);
        });
    }
</script>
</body>
</html>


<!--程式碼解說：-->

<!--HTML 結構: 遵循設計書中的 Wireframe，使用 Bootstrap 5 建立簡單的表單、結果顯示區和歷史紀錄區塊。-->

<!--Bootstrap CSS/JS: 我們直接從 CDN 引入，這讓專案更輕量，無需額外的建置步驟。-->

<!--fetch API: 這是現代瀏覽器中用來發送網路請求的標準函式，取代了傳統的 XMLHttpRequest。我們用它來向後端 POST /shorten 請求。-->

<!--表單驗證: 在 JavaScript 中，我們再次進行 URL 和 TTL 的格式驗證，以提供即時的用戶回饋，符合設計書中**「輸入驗證錯誤時顯示明確訊息」**的要求。-->

<!--localStorage: 我們使用瀏覽器的 localStorage 來儲存最近縮短的 5 個短連結歷史紀錄。這是一種簡單的客戶端儲存方式，即使關閉瀏覽器，資料也不會遺失。-->

<!--複製功能: 使用 navigator.clipboard.writeText() 方法將短連結複製到剪貼簿。-->