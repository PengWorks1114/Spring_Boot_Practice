# 專案名稱

In-Memory URL Shortener（短網址・記憶體版）

## 版本資訊

* 版次：v0.1
* 日期：2025-09-01
* 文件狀態：Draft（可立即依此開發）

---

# 1. 目的與範圍

* **目的**：提供一個以記憶體（In-Memory）為儲存層的短網址服務，重點驗證 Map 暫存、**碰撞處理**與**TTL 到期作廢**的流程。
* **範圍**：

    * 後端 API：`POST /shorten`、`GET /r/{code}`。
    * 前端介面：單頁式（SPA-LESS，純 HTML/CSS/JS）操作頁面，提供縮網址與結果展示。
    * 暫不納入持久化（如 DB/Redis），重啟即遺失資料。

---

# 2. 用語定義

* **URL**：原始長網址。
* **Code**：短碼，Base62 編碼，預設長度 7。
* **TTL**（Time To Live）：有效期限。逾期後短碼作廢。
* **Idempotency**（冪等）：相同（字串完全相同）的 URL 重複縮短，回傳相同 code。

---

# 3. 驗收標準（Acceptance Criteria）

1. `POST /shorten` 輸入有效 URL，回傳 `{code}` 與 `shortUrl`。
2. **相同 URL** 重複縮短，回傳**相同 code**（以字串完全一致為判定）。
3. `GET /r/{code}` 以 **302** 轉址至對應 URL（`Location` 標頭）。
4. 逾期 TTL 的短碼請求 `GET /r/{code}`，回傳 404（或 410），不得轉址。
5. 碰撞處理：不同 URL 生成相同初始 code 時，能自動再生新 code 以避免衝突。
6. 前端頁面可完成縮短與複製短連結，輸入驗證錯誤時顯示明確訊息。

---

# 4. 非功能性需求（NFR）

* **效能**：單機 1,000 RPS 峰值下可正常運作（記憶體 Map 與鎖粒度設計支撐）。
* **可用性**：重啟即遺失資料，屬實驗性服務，可接受暫時性資料遺失。
* **安全**：

    * 僅允許 `http`/`https` 協定。
    * CORS 僅允許前端網頁來源（可配置）。
    * Rate Limit（延伸）：防止濫用。
* **觀測性**：基本存取日誌、錯誤日誌；延伸支援 Metrics。

---

# 5. 系統架構

## 5.1 技術棧

* Java 17 + Spring Boot 3.x（Spring Web, Validation, Scheduling）
* Build：Gradle/Maven 皆可
* API 文件：springdoc-openapi（Swagger UI）
* 前端：原生 HTML + Bootstrap 5 + 原生 JS（Fetch API）

## 5.2 元件劃分

* **ShortenController**：

    * `POST /shorten`：縮網址
    * `GET /r/{code}`：轉址
* **ShortenService**：

    * `shorten(url, ttlSeconds?)`：生成/取得 code（冪等）
    * `resolve(code)`：查詢有效 URL（檢查 TTL）
* **CodeGenerator**：

    * 以 URL 為輸入，生成 Base62 短碼；若衝突則使用增量 salt 再試。
* **InMemoryStore**：

    * `codeToEntry: ConcurrentHashMap<String, Entry>`
    * `urlToCode: ConcurrentHashMap<String, String>`
* **TTLSweeper（@Scheduled）**：

    * 例行掃描過期項目並清除。

---

# 6. 資料模型

```text
Entry {
  String code;         // 短碼
  String url;          // 原始 URL（原樣保存）
  Instant createdAt;   // 建立時間（UTC）
  Instant? expiresAt;  // 到期時間（可為 null 表示不過期或使用預設）
}
```

* **儲存結構**：

    * `Map<String, Entry> codeToEntry`
    * `Map<String, String> urlToCode`
* **TTL 策略**：

    * 若請求未給 `ttlSeconds`：採用系統預設（例如 30 天）。
    * 若指定 `ttlSeconds`：計算 `expiresAt = now + ttlSeconds`。
    * **冪等重複縮短**：若 URL 已存在對應 code，**不更新 TTL**（保持可預期）。

---

# 7. 短碼生成與碰撞處理

## 7.1 規則

* 字元集：`0-9a-zA-Z`（Base62）
* 長度：預設 7（可配置）
* 初始雜湊：`Murmur3_32(url)` 或 `CRC32(url)`，轉為 Base62 後截取/填充

## 7.2 碰撞處理流程

1. 以 URL 產生候選 code。
2. **原子性**檢查：

    * 若 `urlToCode` 已存在 -> 直接回傳既有 code（冪等）。
    * 否則以 `computeIfAbsent`/鎖保護嘗試將 `code -> Entry(url)` 放入。
3. 若 `code` 已被**不同 URL**占用：

    * 使用增量 `salt`（`url#1`, `url#2`, ...）重新計算候選 code，重試直到無衝突。

> 註：以 `urlToCode` 為先決條件可最大化冪等與效能；`codeToEntry` 插入需以極小臨界區域保護，避免併發產生重覆。

---

# 8. API 設計

## 8.1 POST /shorten

* **描述**：將原始 URL 縮短為短碼。
* **Request**

```json
{
  "url": "https://example.com/path?x=1",
  "ttlSeconds": 2592000
}
```

* `url`：必填，必須為 `http|https` 開頭。

* `ttlSeconds`：選填（正整數），未提供則使用系統預設（例：2,592,000 = 30 天）。

* **Response**（201 Created 或 200 OK 若已存在）

```json
{
  "code": "a1B9xYz",
  "shortUrl": "https://short.example/r/a1B9xYz",
  "expiresAt": "2025-10-01T02:34:56Z"
}
```

* **同一 URL 重複縮短**：回應 **200 OK**，回傳相同 `code` 與現有 `expiresAt`（不更新）。

* **錯誤**

    * 400：`E4001_INVALID_URL`（無效或不支援協定）
    * 400：`E4002_TTL_OUT_OF_RANGE`（TTL 非正整數或超過上限）

## 8.2 GET /r/{code}

* **描述**：以 302 轉址至原始 URL。
* **成功**：

    * 狀態碼：302 Found
    * 標頭：`Location: <original-url>`、`Cache-Control: no-store`
* **錯誤**：

    * 404：`E4041_CODE_NOT_FOUND`
    * 404/410：`E4101_CODE_EXPIRED`

---

# 9. 前端介面設計（Web UI）

## 9.1 頁面結構

* **路徑**：`/`
* **區塊**：

    1. Header：專案名稱、簡述。
    2. 表單區：URL 輸入框、TTL 選擇（下拉：1 小時/1 天/7 天/30 天/自訂秒數）、「產生短連結」按鈕。
    3. 結果區：短連結顯示、複製按鈕、開啟按鈕。
    4. 歷史區（Client 端 LocalStorage）：最近 5 筆。
    5. Footer：版本與 API Docs 連結。

## 9.2 版型（Wireframe）

```
+-----------------------------------------------------+
| In-Memory URL Shortener                             |
| 簡介：輸入網址，快速取得短連結（資料儲存在記憶體）   |
+-----------------------------------------------------+
| [URL 輸入框_______________________________]         |
| TTL：( 30天 ▼ )   [自訂秒數____]  [ 產生短連結 ]      |
+-----------------------------------------------------+
| 短連結： https://short.example/r/a1B9xYz            |
| [ 複製 ] [ 在新分頁開啟 ]                           |
+-----------------------------------------------------+
| 近期建立                                           |
| a1B9xYz -> https://example.com/... [複製] [開啟]     |
| ...                                                |
+-----------------------------------------------------+
| v0.1 | API Docs                                    |
+-----------------------------------------------------+
```

## 9.3 互動規格

* **驗證**：

    * URL 必填、格式必須為 `http|https`。
    * TTL（自訂秒數）為正整數且不超過上限（例如 90 天）。
* **錯誤呈現**：表單下方顯示紅色文字；
* **複製功能**：點擊「複製」將短連結寫入剪貼簿；成功顯示 Toast。
* **LocalStorage**：

    * `recentShortLinks = [{code, url, shortUrl, expiresAt}]`，保留最新 5 筆。
* **無障礙**：

    * 表單元素提供 `aria-label`、按鈕具 `title`；鍵盤可操作。

## 9.4 前端與 API 串接（範例）

```javascript
async function shorten() {
  const url = document.querySelector('#url').value.trim();
  const ttlPreset = document.querySelector('#ttlPreset').value; // e.g., 2592000
  const ttlCustom = document.querySelector('#ttlCustom').value; // optional seconds
  const ttlSeconds = ttlCustom ? parseInt(ttlCustom, 10) : (ttlPreset ? parseInt(ttlPreset, 10) : undefined);

  const resp = await fetch('/shorten', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url, ttlSeconds })
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    showError(err.code || 'E_UNKNOWN', err.message || '發生錯誤');
    return;
  }
  const data = await resp.json();
  showResult(data.shortUrl, data.code, data.expiresAt);
  saveToLocal(data);
}
```

---

# 10. 錯誤碼設計

|    HTTP | Code                       | 說明                  |
| ------: | -------------------------- | ------------------- |
|     400 | E4001\_INVALID\_URL        | URL 無效或非 http/https |
|     400 | E4002\_TTL\_OUT\_OF\_RANGE | TTL 非法或超上限          |
|     404 | E4041\_CODE\_NOT\_FOUND    | 找不到短碼               |
| 404/410 | E4101\_CODE\_EXPIRED       | 短碼已過期               |
|     500 | E5001\_INTERNAL\_ERROR     | 非預期錯誤               |

---

# 11. 安全性設計

* 僅接受 `http`/`https` 協定。
* 設定 `X-Content-Type-Options: nosniff`、`Referrer-Policy: no-referrer`。
* CORS 白名單（部署環境指定前端域名）。
* Rate Limiting（延伸）：以 IP/金鑰限制每分鐘請求數。

---

# 12. 設定參數（可環境變數）

| 參數                       | 預設                                   | 說明                       |
| ------------------------ | ------------------------------------ | ------------------------ |
| `APP_BASE_URL`           | [http://localhost](http://localhost) | 產生 `shortUrl` 之 Base URL |
| `CODE_LENGTH`            | 7                                    | 短碼長度                     |
| `DEFAULT_TTL_SECONDS`    | 2,592,000                            | 30 天                     |
| `MAX_TTL_SECONDS`        | 7,776,000                            | 90 天                     |
| `SWEEP_INTERVAL_SECONDS` | 60                                   | 過期清理排程週期                 |

---

# 13. 流程設計

## 13.1 縮網址（POST /shorten）

```
[Valid Request]
  -> Validate URL & TTL
  -> if urlToCode.contains(url):
         return {existing code}
     else
         code = generate(url)
         while codeToEntry.contains(code) && codeToEntry[code].url != url:
             code = generate(url + "#" + (++salt))
         put urlToCode[url] = code
         put codeToEntry[code] = Entry(code, url, now, expires)
  -> Response 201 (or 200 if existed)
```

## 13.2 轉址（GET /r/{code}）

```
find entry by code
if not found -> 404
if expiresAt != null and now > expiresAt -> remove & 404/410
return 302 Location: entry.url
```

## 13.3 過期清理（@Scheduled）

```
每 SWEEP_INTERVAL_SECONDS 執行：
  for (code, entry) in codeToEntry:
    if entry.expiresAt != null && now > entry.expiresAt:
       remove codeToEntry[code]
       remove urlToCode[entry.url]
```

---

# 14. 測試計劃

## 14.1 單元測試

* `CodeGeneratorTest`：同一 URL 產生穩定 code；不同 URL 衝突時能再生。
* `ShortenServiceTest`：

    * 冪等：相同 URL 重複縮短回相同 code。
    * TTL 設定與上限檢查。
    * 逾期後 `resolve` 回傳不存在。
* `TTLSweeperTest`：到期清除。

## 14.2 端到端（E2E）

* `POST /shorten` -> 成功回 201 與 `shortUrl`。
* 重複 `POST /shorten` 同 URL -> 回 200 並回相同 code。
* `GET /r/{code}` -> 302 轉址。
* 到期後 `GET /r/{code}` -> 404。

## 14.3 cURL 範例

```bash
# 建立
curl -s -X POST http://localhost:8080/shorten \
  -H 'Content-Type: application/json' \
  -d '{"url":"https://example.com/a?x=1","ttlSeconds":86400}'

# 重複建立（冪等）
curl -s -X POST http://localhost:8080/shorten \
  -H 'Content-Type: application/json' \
  -d '{"url":"https://example.com/a?x=1"}'

# 轉址
curl -i http://localhost:8080/r/a1B9xYz
```

---

# 15. 風險與限制

* **非持久化**：重啟服務資料即遺失。
* **記憶體成長**：需以 TTL 控制上限、可加上總筆數限制（延伸）。
* **URL 正規化**：本版以字串完全一致為冪等判定；不同大小寫/尾斜線視為不同。

---

# 16. 延伸規劃（Optional）

* 續期/刪除 API：`PATCH /shorten/{code}/ttl`、`DELETE /shorten/{code}`。
* 自訂短碼：`POST /shorten { url, customCode }`，含衝突檢查。
* QR Code 產生、批次建立。
* 追蹤統計：點擊次數、Referer、User-Agent、Geo（需考慮隱私）。
* 外掛持久層：切換至 Redis 或關聯式資料庫。

---

# 17. 部署與執行

* 本地執行：`./mvnw spring-boot:run` 或 `./gradlew bootRun`
* 設定環境變數：`APP_BASE_URL`, `DEFAULT_TTL_SECONDS` 等。
* 反向代理：Nginx 對 `/r/` 啟用快取關閉與正確的 `Location` 轉發。

---

# 18. 驗收清單（Checklist）

* [ ] `POST /shorten` 能成功建立短碼（201）。
* [ ] 相同 URL 重複縮短回同一 code（200）。
* [ ] `GET /r/{code}` 以 302 正確轉址。
* [ ] 過期短碼請求回 404/410，且排程能清出過期資料。
* [ ] 前端可輸入、驗證、取得與複製短連結；LocalStorage 保留 5 筆歷史。
